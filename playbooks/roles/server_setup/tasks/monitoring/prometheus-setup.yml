---
#Setup Blackbox Exporter

- name: Create Blackbox directories
  ansible.builtin.file:
    path: /mnt/media-nvm/Blackbox/
    state: directory
    mode: '0755'
    owner: '{{ superuser_name }}'
    group: '{{ superuser_name }}'

- name: Copy Blackbox configuration file
  ansible.posix.synchronize:
    src: monitoring/prometheus/exporters/blackbox/blackbox.yml
    dest: /mnt/media-nvm/Blackbox/

# Setup Prometheus

- name: Create Prometheus directories
  become: true
  ansible.builtin.file:
    path: '{{ item }}'
    state: directory
    mode: '0755'
    owner: '65534'
    group: '65534'
  loop:
    - /mnt/media-nvm/Prometheus/
    - /mnt/media-nvm/Prometheus/data

- name: Copy Prometheus main and web configuration file
  become: true
  ansible.builtin.copy:
    src: files/monitoring/prometheus/prometheus.yml
    dest: /mnt/media-nvm/Prometheus/
    group: '65534'
    owner: '65534'

- name: Open prometheus port on firewall
  become: true
  ansible.posix.firewalld:
    port: 9090/tcp
    permanent: true
    state: enabled
    immediate: true

## Setup Loki

- name: Create Loki directories
  ansible.builtin.file:
    path: /mnt/media-nvm/Loki
    state: directory
    mode: '0755'
    owner: '{{ superuser_name }}'
    group: '{{ superuser_name }}'

- name: Copy Loki configuration file
  ansible.posix.synchronize:
    src: monitoring/prometheus/stack/loki/loki-config.yaml
    dest: /mnt/media-nvm/Loki/loki-config.yaml

## Setup Promtail

- name: Create Promtail directories
  ansible.builtin.file:
    path: /mnt/media-nvm/Promtail/config
    state: directory
    mode: '0755'
    owner: '{{ superuser_name }}'
    group: '{{ superuser_name }}'

- name: Copy Promtail configuration file
  ansible.posix.synchronize:
    src: monitoring/prometheus/stack/promtail/promtail-config.yaml
    dest: /mnt/media-nvm/Promtail/config/promtail-config.yaml

# Docker Compose with all services

- name: Create Monitoring directories
  ansible.builtin.file:
    path: /mnt/media-nvm/Monitoring
    state: directory
    mode: '0755'
    owner: '{{ superuser_name }}'
    group: '{{ superuser_name }}'

- name: Copy Docker-compose file
  ansible.posix.synchronize:
    src: files/monitoring/prometheus/docker-compose.yml
    dest: /mnt/media-nvm/Monitoring/

- name: Run Prometheus Stack
  community.docker.docker_compose_v2:
    project_src: /mnt/media-nvm/Monitoring

...